<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <%- include('../partials/head') %>
  <title><%= pagetitle %></title>
</head>
<body>
  <%- include('../partials/header') %>

  <div class="main">
    <div class="main-content">
      <div class="container">
        
        <!-- Header -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
              <h1 class="mb-0"><%= pagetitle %></h1>
              <a href="/admin/board" class="btn btn-secondary">
                Voltar aos Boards
              </a>
            </div>
          </div>
        </div>

        <div class="text-center mb-4">
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCardModal">
            + Criar Novo Card
          </button>
        </div>

        <div class="modal fade" id="createCardModal" tabindex="-1" aria-labelledby="createCardModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <form action="/admin/cards" method="POST" class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="createCardModalLabel">Criar Novo Card</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label for="cardTitle" class="form-label">Título</label>
                  <input type="text" class="form-control" id="cardTitle" name="title" required />
                </div>
                <div class="mb-3">
                  <label for="cardDescription" class="form-label">Descrição</label>
                  <textarea class="form-control" id="cardDescription" name="description" rows="3"></textarea>
                </div>
                <input type="hidden" name="project_id" value="<%= projectId %>" />
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Criar Card</button>
              </div>
            </form>
          </div>
        </div>

        <div class="row g-3">

          <%        const columns = [
            { name: 'A Fazer', cards: todoCards, class: 'secondary' },
            { name: 'Em Progresso', cards: progressCards, class: 'warning' },
            { name: 'Em Revisão', cards: reviewCards, class: 'info' },
            { name: 'Aprovado', cards: approvedCards, class: 'success' }
        ];%>

          <% columns.forEach(col => { %>
            <div class="col-lg-3 col-md-6">
              <div class="box h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0 text-<%= col.class %>"><%= col.name %></h5>
                  <span class="badge bg-<%= col.class %>"><%= col.cards ? col.cards.length : 0 %></span>
                </div>
                
                <div style="max-height: 60vh; overflow-y: auto;">
                  <% if (!col.cards || col.cards.length === 0) { %>
                    <div class="text-center text-muted py-4">
                      <i class="bx bx-inbox fs-2 d-block mb-2"></i>
                      <small>Nenhum card nesta coluna</small>
                    </div>
                  <% } else { %>
                    <% col.cards.forEach(card => { %>
                      <div class="card mb-3 border-start border-<%= col.class %> border-3">
                        <div class="card-body p-3">
                          <h6 class="card-title mb-2"><%= card.title %></h6>
                          <% if (card.description) { %>
                            <p class="card-text small text-muted mb-2"><%= card.description %></p>
                          <% } %>
                          
                          <!-- Tarefas -->
                          <% if (card.tasks && card.tasks.length > 0) { %>
                            <div class="mb-3">
                              <small class="text-muted d-block mb-1">
                                <i class="bx bx-task"></i> Tarefas:
                              </small>
                              <% card.tasks.forEach(task => { %>
                                <div class="bg-light p-2 mb-1 rounded small">
                                  <strong class="d-block"><%= task.task_name %></strong>
                                  <% if (task.description) { %>
                                    <span class="text-muted"><%= task.description %></span>
                                  <% } %>
                                </div>
                              <% }) %>
                            </div>
                          <% } else { %>
                            <small class="text-muted d-block mb-3">
                              <i class="bx bx-info-circle"></i> Nenhuma tarefa atribuída
                            </small>
                          <% } %>
                          
                          <!-- Ações -->
                          <div class="d-flex flex-column gap-2">
                            <a href="/admin/cards/<%= card.id %>" class="btn btn-sm btn-outline-<%= col.class %>">
                              <i class="bx bx-show"></i> Ver Detalhes
                            </a>
                            
                            <form action="/admin/cards/<%= card.id %>/status?_method=PATCH" method="POST" class="d-flex gap-1">
                              <select name="status" class="form-select form-select-sm" required>
                                <option value="">Mover para...</option>
                                <option value="todo" <%= card.status === 'todo' ? 'selected' : '' %>>A Fazer</option>
                                <option value="progress" <%= card.status === 'progress' ? 'selected' : '' %>>Em Progresso</option>
                                <option value="review" <%= card.status === 'review' ? 'selected' : '' %>>Em Revisão</option>
                                <option value="approved" <%= card.status === 'approved' ? 'selected' : '' %>>Aprovado</option>
                              </select>
                              <button type="submit" class="btn btn-sm btn-primary">
                                <i class="bx bx-check"></i>
                              </button>
                            </form>
                            
                            <form action="/admin/cards/<%= card.id %>?_method=DELETE" method="POST" onsubmit="return confirm('Tem certeza que deseja deletar este card?');">
                              <button type="submit" class="btn btn-sm btn-outline-danger w-100">
                                <i class="bx bx-trash"></i> Excluir
                              </button>
                            </form>
                          </div>
                        </div>
                      </div>
                    <% }) %>
                  <% } %>
                </div>
              </div>
            </div>
          <% }); %>

        </div>
      </div>
    </div>
  </div>

  <div class="overlay"></div>
  <%- include('../partials/footer') %>
</body>
</html>
